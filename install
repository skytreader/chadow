# vim: set ft=sh:
source ~/.venvburrito/bin/virtualenvwrapper.sh
set -e -v
mkdir ~/.chadow
touch ~/.chadow/config.json
version="$(cat VERSION)"
echo "{\"version\": \"$version\", \"libraryMapping\":{}}" > ~/.chadow/config.json

echo "Building and installing chadow Java dependencies..."
gradle jar
echo "Making JAR 'executable'..."
mv build/libs/chadow-$version.jar /opt/bin/
echo "java -jar chadow-$version.jar \$@" > /opt/bin/chadow
chmod +x /opt/bin/chadow

# Turn off verbose since it is too noisy for lsvirtualenv.
set +v
chadow_existence="$(lsvirtualenv | grep chadow | wc -l)"
set -v

echo "existence: $chadow_existence"

if [ "$chadow_existence" != 0 ]; then
    echo "A chadow virtualenv exists. Please completely uninstall chadow first."
    exit 1
fi

# Turn off error exit since, for some reason, this install script halts on
# mkvirtualenv with exit error on.
# Turn off verbose since virtualenv is noisy.
set +e +v
echo "Creating chadow virtualenv..."
mkvirtualenv chadow -p python3
echo "virtualenv created."
set -e

# For some reason, without the next two echo statements, installation fails on
# Travis CI.
echo "Working on virtualenv..."
workon chadow
echo "Now on virtualenv. Turning verbose on again."
set -v
pip install -r requirements.txt
cp chadow.py ~/.chadow
echo "Done installing. Do 'workon chadow' to start using chadow."
